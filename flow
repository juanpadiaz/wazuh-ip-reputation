graph TD
    A[ğŸš€ Inicio del Sistema] --> B[ğŸ“ Cargar ConfiguraciÃ³n]
    B --> C{ğŸ” AutenticaciÃ³n Wazuh}
    C -->|âœ… Ã‰xito| D[â° Iniciar Monitoreo]
    C -->|âŒ Error| E[ğŸš¨ Log Error y Salir]
    
    D --> F[ğŸ“Š Extraer IPs de Logs Wazuh]
    F --> G[ğŸ” Filtrar IPs PÃºblicas]
    G --> H{ğŸ†” IPs Nuevas?}
    H -->|âŒ No| I[â¸ï¸ Esperar Intervalo]
    H -->|âœ… SÃ­| J[ğŸ”„ Procesar IPs]
    
    J --> K[ğŸ“¡ Consultar VirusTotal]
    K --> L[â³ Rate Limiting 1s]
    L --> M[ğŸ›¡ï¸ Consultar AbuseIPDB]
    M --> N[â³ Rate Limiting 1s]
    N --> O[ğŸ“ˆ Calcular Riesgo]
    
    O --> P{âš ï¸ IP Maliciosa?}
    P -->|âŒ No| Q[âœ… Marcar IP como Procesada]
    P -->|âœ… SÃ­| R[ğŸš¨ Agregar a Lista Maliciosa]
    
    Q --> S{ğŸ”„ MÃ¡s IPs?}
    R --> S
    S -->|âœ… SÃ­| K
    S -->|âŒ No| T{ğŸ“§ Hay IPs Maliciosas?}
    
    T -->|âŒ No| U[ğŸ’¾ Guardar Resultados]
    T -->|âœ… SÃ­| V[ğŸ“¤ Enviar Alerta Email]
    V --> U
    
    U --> W[ğŸ§¹ Limpiar Cache si > 1000]
    W --> I
    I --> F
    
    %% Subprocesos detallados
    K --> K1[ğŸ” VirusTotal API]
    K1 --> K2[ğŸ“Š Analizar Positivos/Total]
    K2 --> K3[âš–ï¸ Evaluar Umbral â‰¥ 3]
    
    M --> M1[ğŸ” AbuseIPDB API]
    M1 --> M2[ğŸ“Š Analizar Confianza %]
    M2 --> M3[âš–ï¸ Evaluar Umbral â‰¥ 25%]
    
    V --> V1[ğŸ“ Crear HTML Email]
    V1 --> V2[ğŸ“§ SMTP EnvÃ­o]
    V2 --> V3[ğŸ“‹ Tabla con Detalles]
    
    %% Conexiones externas
    F -.-> WAZUH[ğŸ›¡ï¸ Wazuh Server<br/>API REST]
    K1 -.-> VT[ğŸ” VirusTotal<br/>API v2]
    M1 -.-> ABUSE[ğŸ›¡ï¸ AbuseIPDB<br/>API v2]
    V2 -.-> SMTP[ğŸ“§ SMTP Server<br/>Gmail/Outlook]
    
    %% ConfiguraciÃ³n
    B -.-> CONFIG[ğŸ“ config file<br/>APIs, Wazuh, Email]
    
    %% Almacenamiento
    U -.-> JSON[ğŸ’¾ JSON Results<br/>Timestamped]
    
    %% Error Handling
    E --> END[ğŸ”š Terminar]
    
    %% Estilos
    classDef startEnd fill:#e1f5fe,stroke:#0277bd,stroke-width:2px
    classDef process fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef decision fill:#fff3e0,stroke:#ef6c00,stroke-width:2px
    classDef external fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px
    classDef storage fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    classDef error fill:#ffebee,stroke:#d32f2f,stroke-width:2px
    
    class A,D,END startEnd
    class B,F,G,J,K,L,M,N,O,Q,R,U,V,W process
    class C,H,P,S,T decision
    class WAZUH,VT,ABUSE,SMTP external
    class CONFIG,JSON storage
    class E error
